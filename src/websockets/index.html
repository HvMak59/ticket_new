<!-- <!DOCTYPE html>
<html>

<head>
    <title>Telemetry WebSocket</title>
</head>

<body>
    <h1>Telemetry Payload Demo</h1>

    <button id="btnSubA">Subscribe Metric A</button>
    <button id="btnSubB">Subscribe Metric B</button>

    <h2>Incoming Data</h2>
    <div id="data"></div>

    <script>
        // Connect WebSocket
        const socket = new WebSocket('ws://localhost:3000');

        socket.addEventListener('open', () => {
            console.log('Connected to WebSocket server');
        });

        socket.addEventListener('message', (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log("Incoming:", data);

                const div = document.createElement("div");
                div.innerHTML = `
          <pre>${JSON.stringify(data, null, 2)}</pre>
          <hr/>
        `;
                document.getElementById('data').prepend(div);
            } catch (err) {
                console.error("Invalid message:", event.data);
            }
        });

        socket.addEventListener('close', () => {
            console.log("Disconnected from WebSocket");
        });

        socket.addEventListener('error', (err) => {
            console.error("WebSocket error:", err);
        });

        // Send subscription message (MATCHES BACKEND)
        function subscribe(metricId) {
            const payload = {
                virtualDeviceIds: ["1:first"],   // can be multiple
                metricsAttributeId: metricId
            };

            socket.send(JSON.stringify(payload));
            console.log("Subscribed:", payload);
        }

        // Buttons
        document.getElementById("btnSubA")
            .addEventListener("click", () => subscribe("metrics_4"));

        document.getElementById("btnSubB")
            .addEventListener("click", () => subscribe("longitude"));
    </script>
</body>

</html> -->





<!DOCTYPE html>
<html>

<head>
    <title>Telemetry WebSocket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        button {
            margin-right: 10px;
            padding: 8px 12px;
        }

        pre {
            background: #111;
            color: #0f0;
            padding: 10px;
        }
    </style>
</head>

<body>
    <h1>Telemetry WebSocket Demo</h1>

    <button id="btnSubA">Subscribe Metric A</button>
    <button id="btnSubB">Subscribe Metric B</button>

    <h2>Incoming Data</h2>
    <div id="data"></div>

    <!-- <script>
        // 1ï¸âƒ£ Connect RAW WebSocket
        const socket = new WebSocket('ws://localhost:3000/telemetry');
        // const socket = new WebSocket('wss://5f23-2405-201-2020-61-5564-9904-1b37-9299.ngrok-free.app');

        socket.addEventListener('open', () => {
            console.log('Connected to WebSocket server');
        });

        socket.addEventListener('message', (event) => {
            try {
                const msg = JSON.parse(event.data);
                console.log("ðŸ“© Incoming:", msg);

                const div = document.createElement("div");
                div.innerHTML = `
          <strong>Type:</strong> ${msg.type}<br/>
          <pre>${JSON.stringify(msg.data, null, 2)}</pre>
          <hr/>
        `;
                document.getElementById('data').prepend(div);
            } catch (err) {
                console.error("âŒ Invalid message:", event.data);
            }
        });

        socket.addEventListener('close', () => {
            console.log("âŒ Disconnected from WebSocket");
        });

        socket.addEventListener('error', (err) => {
            console.error("âŒ WebSocket error:", err);
        });

        // 2ï¸âƒ£ Subscribe (MATCHES BACKEND CONTRACT)
        function subscribe(metricId) {
            const payload = {
                // event: "subscribe",
                // data: {
                virtualDeviceIds: ["v1"],
                metricsAttributeId: metricId,
                startTime: Date.now() - 60 * 60 * 1000, // last 1 hour
                endTime: Date.now()
                // }
            };

            socket.send(JSON.stringify(payload));
            console.log("ðŸ“¤ Sent subscribe:", payload);
        }

        // 3ï¸âƒ£ Buttons
        document
            .getElementById("btnSubA")
            .addEventListener("click", () => subscribe("power"));

        document
            .getElementById("btnSubB")
            .addEventListener("click", () => subscribe("longitude"));
    </script> -->

    <script>
        const socket = new WebSocket('ws://localhost:3000/telemetry');

        socket.addEventListener('open', () => {
            console.log('Connected to WebSocket server');
        });

        socket.addEventListener('message', (event) => {
            try {
                const payload = JSON.parse(event.data);
                console.log("Incoming:", payload);

                const div = document.createElement("div");
                div.innerHTML = `
        <strong>VID:</strong> ${payload.data.telemetryDevice?.virtualDeviceId}<br/>
        <strong>Metric:</strong> ${payload.data.telemetryDisplayProperty?.metricsAttributeId}<br/>
        <strong>Unit:</strong> ${payload.data.telemetryDisplayProperty?.unit}<br/>
        <pre>${JSON.stringify(payload.data.metrics, null, 2)}</pre>
        <hr/>
      `;
                document.getElementById('data').prepend(div);

            } catch (err) {
                console.error("Invalid message:", event.data);
            }
        });

        function subscribe(metricId, virtualDeviceId) {
            const payload = {
                type: "subscribe",
                data: {
                    virtualDeviceId: virtualDeviceId,
                    metricsAttributeId: metricId,
                    startTime: 1770748200000,
                    endTime: 1770831000000
                }
            };

            socket.send(JSON.stringify(payload));
            console.log("Sent subscribe:", payload);
        }

        document.getElementById("btnSubA")
            .addEventListener("click", () => subscribe("Output_Power", "Super Specialist Technocrats LLP:SST Inverters"));

        document.getElementById("btnSubB")
            .addEventListener("click", () => subscribe("power", "v1"));
    </script>

</body>

</html>